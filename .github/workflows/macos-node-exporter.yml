name: macOS node_exporter via Ansible

on:
  workflow_dispatch:
  push:
    paths:
      - "*.yml"
      - "*.ini"
      - ".github/workflows/macos-node-exporter.yml"

jobs:
  deploy:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ansible (venv)
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          python -m pip install -U pip
          pip install ansible

      - name: Run playbook
        run: |
          source .venv/bin/activate
          ansible-playbook -i hosts.ini deploy.yml -vv

      - name: Show service status and logs (debug)
        if: always()
        run: |
          sudo launchctl print system/com.prometheus.node_exporter || true
          sudo tail -n 200 /var/log/node_exporter.log || true
          sudo tail -n 200 /var/log/node_exporter.err || true
          curl -fsS http://127.0.0.1:9100/metrics | head -n 20 || true